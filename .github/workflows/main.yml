name: Crafty + Ngrok Automation

on:
  workflow_dispatch:
  schedule:
    # Codziennie co 6 godzin (przykład)
    - cron: '0 */6 * * *'

jobs:
  crafty-ngrok:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------
      # Instalacja Dockera
      # -----------------------
      - name: Install Docker & Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose
          docker --version
          docker-compose --version

      # -----------------------
      # Instalacja screen
      # -----------------------
      - name: Install screen
        run: sudo apt-get install -y screen

      # -----------------------
      # Instalacja Ngrok
      # -----------------------
      - name: Install Ngrok
        run: |
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}

      # -----------------------
      # Start Ngrok w screenie
      # -----------------------
      - name: Start Ngrok tunnel
        run: |
          screen -dmS ngrok ngrok http 8443
          # zapisujemy URL ngrok do pliku
          sleep 5
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo $NGROK_URL > ngrok-url.txt

      # -----------------------
      # Upload Ngrok URL jako artifact
      # -----------------------
      - name: Upload Ngrok URL
        uses: actions/upload-artifact@v4
        with:
          name: ngrok-url
          path: ngrok-url.txt

      # -----------------------
      # Backup docker folder
      # -----------------------
      - name: Backup Docker folder
        run: |
          BACKUP_FILE="docker-backup-$(date +'%Y%m%d-%H%M%S').tar.gz"
          tar -czf $BACKUP_FILE docker
          ls -lh $BACKUP_FILE

      # -----------------------
      # Start Crafty z backupu
      # -----------------------
      - name: Restore & Start Crafty
        run: |
          # Jeśli masz starszy backup, go rozpakowujemy
          LATEST_BACKUP=$(ls -t docker-backup-*.tar.gz | head -n1 || echo "")
          if [ -f "$LATEST_BACKUP" ]; then
            tar -xzf $LATEST_BACKUP -C .
          fi
          docker-compose up -d
          docker-compose logs -f
