name: Crafty Controller Auto Backup

on:
  workflow_dispatch:
  schedule:
    # restart workflow co 6h (GitHub limit safety)
    - cron: '0 */6 * * *'

jobs:
  crafty:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Restore latest docker backup
        run: |
          if [ -f backups/docker-backup-latest.tar.gz ]; then
            echo "Restoring docker/ from latest backup"
            rm -rf docker
            tar -xzf backups/docker-backup-latest.tar.gz
          else
            echo "No backup found â€“ starting fresh"
          fi

      - name: Start Crafty (docker-compose)
        run: |
          cd docker
          docker-compose up -d
          docker-compose logs -f &
          echo $! > logs.pid

      - name: Run Crafty for 5h 50min
        run: sleep $((5*3600 + 50*60))

      - name: Stop Crafty
        run: |
          cd docker
          docker-compose down
          if [ -f logs.pid ]; then
            kill "$(cat logs.pid)" || true
          fi

      - name: Backup docker directory
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          mkdir -p backups
          tar -czf backups/docker-backup-latest.tar.gz docker
          cp backups/docker-backup-latest.tar.gz backups/docker-backup-$TIMESTAMP.tar.gz

      - name: Commit backup to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add backups
          git commit -m "Crafty backup $TIMESTAMP" || echo "Nothing to commit"
          git push

      - name: Wait remaining time (5 min)
        run: sleep 300
