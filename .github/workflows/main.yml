name: Crafty Controller + Ngrok

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  crafty:
    runs-on: ubuntu-latest
    env:
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      REPO: ${{ github.repository }}
      BACKUP_FILE: crafty_backup.tar.gz

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y screen curl

    - name: Install Ngrok
      run: |
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
          | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null \
          && echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
          | sudo tee /etc/apt/sources.list.d/ngrok.list \
          && sudo apt update \
          && sudo apt install -y ngrok

        ngrok config add-authtoken $NGROK_AUTH_TOKEN

    - name: Backup Crafty Controller
      run: |
        tar czf $BACKUP_FILE crafty_data || echo "No crafty_data folder yet"

    - name: Commit backup
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add $BACKUP_FILE
        git commit -m "Automated backup: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push origin main || echo "Push failed (likely no changes)"

    - name: Start Crafty Controller in Docker
      run: |
        screen -dmS crafty \
        bash -c "docker run --rm -p 8443:8443 -v $PWD/crafty_data:/crafty_data ghcr.io/yourusername/crafty-controller:latest"

    - name: Start Ngrok in screen
      run: |
        screen -dmS ngrok \
        bash -c "ngrok http 8443"

    - name: Show Ngrok public URL
      run: |
        sleep 5
        curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'

